---
title: "Case Study V Interim Report I"
author: "Jake Epstein, Daniel Spottiswood, Sahil Patel, Michael Tan, Man-Lin Hsiao"
date: "11/10/2019"
output: html_document
---

```{r, echo = FALSE, message = FALSE}
library(haven)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(xtable)
library(xgboost)
library(randomForest)
library(twang)
library(VIM)
library(lattice)
library(mice)
library(survival)
library(survminer)


cardio = read.csv("data/dukecathr.csv")
 
# CATEGORICAL OR BINARY VARIABLES:
cardio$DEATH = as.factor(cardio$DEATH)
cardio$GENDER = as.factor(cardio$GENDER)



select = dplyr::select
```


```{r}
ggplot(cardio, aes(x = DAYS2LKA, fill = DEATH==1)) +
  geom_density(alpha = 0.5) +
  labs(title = "Days to Death or Last Contact", fill = "Dead", x = "Days to Death or Last Contact", y = "Density") +
  theme_minimal()
```
This chart confirms what we expect. We see that most of the early deaths are accounted for but that longer term survivors often lose contact before a confirmed death.

```{r}
cardio_na = sapply(cardio, function(x) sum(is.na(x)))
cardio_nas = data.frame(cardio_na, colnames(cardio), stringsAsFactors = FALSE) %>% 
  mutate(cardio_na_p = 100*cardio_na/nrow(cardio)) %>%
  arrange(cardio_na) %>% filter(cardio_na > 0) 
cardio_nas$colnames.cardio. = factor(cardio_nas$colnames.cardio., levels = cardio_nas$colnames.cardio.)
ggplot(cardio_nas, aes(x = colnames.cardio., y = cardio_na_p, fill = colnames.cardio.)) +
  geom_bar(stat="identity", show.legend = FALSE) + 
  labs(title = "Missing Data Proportions", x = "", y = "Percent Missing") +
  theme_minimal() +
  coord_flip()
```
We see several variables with missing data rates over 50 percent, and many more in the ~20-40% range. 
```{r}
# md.pattern(cardio %>% dplyr::select(DSSTROKE, DSMI))
# cardio_aggr <- aggr(cardio,col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
# labels=names(cardio),cex.axis=.7, gap=3, 
# ylab=c("Proportion missing","Missingness Pattern"))
```

Most instances of large missing data are for events that likely never occurred, such as all the "days to first subsequent" variables like DSSTROKE (having a stroke in the future) and DSMI (having a non-fatal myocardianl infarction in the future), or "days to closest previous" variables like DPCABG (having a previous coronary artery bypass surgery).

On the other hand, some variables with a significant amount of missing data do not have easily interpretable explanations. For example laboratory measurements such as LDL_R, HDL_R, and TOTCHOL_R have significant proportions of missing data, but there is no straightforward explanation to why these measurements may not have been recorded for certain patients.  


```{r}
deathdf = data.frame()
missingvals = list('DSSTROKE', 'DSMI', 'GRAFTST', 'DPCABG', 'DSCABG', 'DPPCI', 'LDL_R', 'HDL_R', 'TOTCHOL_R', 'DPMI', 'DSPCI', 'LVEF_R', 'CREATININE_R', 'LCXST', 'RCAST', 'PRXLADST', 'LADST', 'LMST', 'DIASBP_R', 'SYSBP_R', 'NUMDZV', 'CHFSEV', 'PULSE_R', 'S3')
for(val in missingvals){
  missing <- cardio[which(is.na(eval(parse(text=paste('cardio',"$",val,sep=""))))),]
  notmissing <- cardio[which(!is.na(eval(parse(text=paste('cardio',"$",val,sep=""))))),]
  
  percentdeathmissing = summary(missing$DEATH)[2] / (summary(missing$DEATH)[2] + summary(missing$DEATH)[1])
  percentdeathnotmissing = summary(notmissing$DEATH)[2] / (summary(notmissing$DEATH)[2] + summary(notmissing$DEATH)[1])
  
  deathdf[paste(val,'missing'), 'deathpercentage'] = percentdeathmissing
  deathdf[paste(val,'missing'), 'subset'] = 'missing'
  deathdf[paste(val, 'missing'), 'name'] = val
  deathdf[paste(val,'observed'), 'deathpercentage'] = percentdeathnotmissing
  deathdf[paste(val,'observed'), 'subset'] = 'observed'
  deathdf[paste(val, 'observed'), 'name'] = val
}

ggplot(deathdf, aes(name, deathpercentage, fill = subset)) + 
    geom_bar(stat = "identity", position = "dodge") + 
    labs(title="Percentage Deaths in Missing VS Observed Data", 
         x = "Variable", y = "% Deaths") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
In order to investigate how missing data affects the outcome of death, we plotted the percentage of deaths in every variable for the subset where data on the variable is missing, and the subset where data on the variable is observed. Through the graph, we can notice that five specific variables: CHFSEV, CREATININE_R, PULSE_R, S3, and TOTCHOL_R have particularly large differences in percentage deaths for their observed versus missing subsets. For all five variables, there was a higher percentage of deaths for the subset of data that is missing. This suggests that for these variables, there is a possibility that data may be MNAR (missing not at random). 


```{r}
marginplot(cardio[, c("CREATININE_R", "DAYS2LKA")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)
marginplot(cardio[, c("S3", "DAYS2LKA")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)

marginplot(cardio[, c("PULSE_R", "DAYS2LKA")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)
```
We continued to investigate the five aforementioned variables and their effects on DAYS2LKA through margin plots. Although there were no noteworthy differences in distribution for CHSEV and TOTCHOL_R, we did find that missing data seems to effect DAYS2LKA for the variables CREATININE_R, S3, and PULSE_R. For all three of these variables, subsets of missing data have boxplots with higher means, indicating that patients missing data on these variables died later than patients with observed data. 

We will proceed with visualizations that may help determine any similar patterns for missing data in different variables.

```{r}
cardio_aggr <- aggr(cardio[,c(38:41)],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cardio[,c(38:41)]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

cardio_aggr <- aggr(cardio[,c(30:33)],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cardio[,c(30:33)]),cex.axis=.6, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))
```

Through examining the variables with the highest proportion of missing data with missingness pattern visualizations, the following can be seen:

1) When looking at GRAFTST, LCXST, LADST, and LMST, all four of these have missing values together 10.4% of the time. These are all catetherization results, so it could be the case the post-catetherization measurements were not done well or completely. It is likely that the missing data results from cases where the doctor just did not bother to measure all the metrics after catetherization, which would mean that the data is missing completely at random (MCAR).

2) When looking at LDL_R, HDL_R, TOTCHOL_R, and CREATININE_R, the variables excluding CREATININE_R have missing values together 37% of the time, and all four are missing 24% of the time. We continue to investigate this in the following graphs.

```{r}
marginplot(cardio[, c("CREATININE_R", "YRCATH_G")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)
marginplot(cardio[, c("TOTCHOL_R", "YRCATH_G")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)
marginplot(cardio[, c("HDL_R", "YRCATH_G")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)
marginplot(cardio[, c("LDL_R", "YRCATH_G")], col = mdc(1:2), cex.numbers = 0.4, pch = 1)
```

Through these margin plots, we can see there is a significant non-overlap in the distribution of YRCATH_G (year of catetherization) data depending on whether the laboratory measurements were missing versus observed. The majority of missing data on all these laboratory measurements comes from early years, while all the observed data comes from later years. A likely explanation is that these laboratory procedures were less common or accessible in the earlier years. From this, we can determine that this data is missing at random (MAR). 


Through these exploratory data analysis and missing data visualizations, we can determine that significant portions of missing data are due to either events that never occurred and therefore cannot be recorded, possible negligence in recording certain measurements (MCAR), and reasons that depend on other observed variables, such as less accessible laboratory procedures in earlier years leading to missing data (MAR).


### Build Model

```{r, fig.height= 15, fig.width = 7}
# select data we want
# note: selected from fan's slides

cardio_new = cardio %>%
  select(
    YRCATH_G, #year
    AGE_G, #age
    GENDER,
    RACE_G,
    HXSMOKE, #history of smoking
    WEIGHT_R, # in kg
    HEIGHT_R, # in cm
    HXCEREB, #history of stroke
    CHFSEV, # congestive heart failure severity
    HXCOPD, # history of COPD
    HXDIAB, # diabetes 
    DPMI, #days to previous myocardial infarction. No MI encoded as missing --> will change this to a binary 
    HXHYL, #history of hyperlipidemia 
    S3, #S3 gallop
    LMST, #maximum stenosis of left main artery
    NUMDZV, #number of diseased vessels
    DEATH,
    DAYS2LKA # days until last known alive
  ) %>%
  mutate(BMI = WEIGHT_R / (HEIGHT_R / 100) ^ 2, HXMI = 1 - is.na(DPMI), DEATH = as.numeric(DEATH), RACE_G = as.factor(RACE_G),
         CHFSEV = as.factor(CHFSEV), LMST = 100 * LMST, YRCATH_G = as.factor(YRCATH_G), AGE_G = as.factor(AGE_G)) %>%
  select(-WEIGHT_R, -HEIGHT_R, -DPMI)
```

```{r}
#complete case model

formula_call = Surv(DAYS2LKA, DEATH) ~ YRCATH_G + AGE_G + GENDER + RACE_G + HXSMOKE + HXCEREB + CHFSEV + HXCOPD + HXDIAB + HXHYL + S3 + LMST + NUMDZV

fit.coxph <- coxph(formula_call, data = cardio_new)

ggsave("output/cox_graph_complete_case.png", ggforest(fit.coxph, data=cardio_new), device = "png", width = 7, height = 10, units = "in")
```


```{r}
# use multiple imputation with mice
#note: this takes a long time to run, so toggle rerunMICE to recalculate
#think we could make this go faster by parsing every factor as an int before running MICE, then refactoring before running the coxph


rerunMICE = FALSE

if(rerunMICE){
  imp = mice(cardio_new, m = 10)
  saveRDS(imp, "data/imp.rds")
} else {imp = readRDS("data/imp.rds")}


densityplot(imp)

#note, cant replace formula with formula_call here for some reason
coximpute = with(imp,coxph(Surv(DAYS2LKA, DEATH) ~ YRCATH_G + AGE_G + GENDER + RACE_G + HXSMOKE + HXCEREB + CHFSEV + HXCOPD + HXDIAB + HXHYL + S3 + LMST + NUMDZV))
summary(pool(coximpute))
```


```{r}
# compare methods

mice_output = summary(pool(coximpute)) %>% select(estimate, std.error)
mice_output$variable = rownames(mice_output)
mice_output$procedure = "MICE"

fixed_output = data.frame(estimate = summary(fit.coxph)$coefficients[,1],  std.error = summary(fit.coxph)$coefficients[,3])
fixed_output$variable = rownames(fixed_output)
fixed_output$procedure = "compete cases"

output = rbind(mice_output, fixed_output)

comparison_plot = ggplot(output, aes (x = variable, y = exp(estimate), color = procedure))+
  geom_point(shape = "square", size = 3)+
  geom_errorbar(aes(ymin = exp(estimate - 2 * std.error), ymax = exp(estimate + 2 * std.error))) +
  geom_hline(yintercept = 1) +
  coord_flip() +
  scale_y_continuous(trans = "log2")+
  labs(main = "Comparison of Procedures", x = "Variable", y = "Hazard Ratio", fill = "Procedure")+
  theme_minimal()


ggsave("output/cox_graph_compare.png", comparison_plot, device = "png", width = 7, height = 8, units = "in")

```

```{r}
#pred <- survfit(fit.coxph, cardio_new)
#timepoints <- c(0, pred$YR_CATH_)
```
